import textwrap
import re

ESCAPE = chr(27)
text_colours = {"red" : 65, "green" : 66, "yellow" : 67 , "blue" : 68, "magenta" : 69, "cyan" : 70, "white" : 71}

def post_remove_emojis(post, config):
    # remove pesky emoji characters
    
    if config["emoji_support"] == True:
        # leave supported emoji
        emoji_pattern = re.compile("[" # our unicode ranges go here. this will need frequent tweaking
                                  u"\U00002300-\U000023FF" # misc technical
                                  u"\U0001F680-\U0001F6FF" # transport & map symbols
                                  u"\U0001F1E6-\U0001F1FF" # regional indicator symbols
                                   "]+", flags=re.UNICODE)
    else:
        emoji_pattern = re.compile("[" # our unicode ranges go here. this will need frequent tweaking
                                  u"\U00002300-\U000023FF" # misc technical
                                  u"\U000024C2-\U0001F251" # enclosed characters including flags
                                  u"\U0001F1E6-\U0001F1FF" # regional indicator symbols
                                  u"\U0001F300-\U0001F5FF" # symbols & pictographs
                                  u"\U0001F600-\U0001F67F" # emoticons
                                  u"\U0001F680-\U0001F6FF" # transport & map symbols
                                  u"\U0001F900-\U0001F9FF" # Supplemental Symbols and Pictographs
                                   "]+", flags=re.UNICODE)
    post = emoji_pattern.sub(r'', post)
    return post

def post_highlight_query(post, query, config):
    post = post.replace((" " + query + " "),
                          (ESCAPE + chr(text_colours[config["search_highlight"]]) + query + ESCAPE + chr(text_colours[config["post_colour"]])))
    return post

def charsub(text):
    # do any substitutitons that will change the length of the text
    text = text.replace("Â­", "") # strip soft hyphens as wrapping text is hard enough already
    text = text.replace("â€¦", "...")
    text = text.replace("&lt;", "<")
    text = text.replace("&gt;", ">")
    text = text.replace("&amp;", "&")
    
    # digraphs and ligatures
    text = text.replace("Ç±", "DZ")
    text = text.replace("Ç²", "Dz")
    text = text.replace("Ç³", "dz")
    text = text.replace("Ç„", "DÅ½")
    text = text.replace("Ç…", "DÅ¾")
    text = text.replace("Ç†", "dÅ¾")
    #text = text.replace("Ä²", "IJ") # supported in Latin G2
    #text = text.replace("Ä³", "ij") # supported in Latin G2
    text = text.replace("Ç‡", "LJ")
    text = text.replace("Çˆ", "Lj")
    text = text.replace("Ç‰", "lj")
    text = text.replace("ÇŠ", "NJ")
    text = text.replace("Ç‹", "Nj")
    text = text.replace("ÇŒ", "nj")
    text = text.replace("áµº", "th")
    text = text.replace("êœ²", "AA")
    text = text.replace("êœ³", "aa")
    #text = text.replace("Ã†", "AE") # supported in Latin G2
    #text = text.replace("Ã¦", "ae") # supported in Latin G2
    text = text.replace("êœ´", "AO")
    text = text.replace("êœµ", "ao")
    text = text.replace("êœ¶", "AU")
    text = text.replace("êœ·", "au")
    text = text.replace("êœ¸", "AV")
    text = text.replace("êœ¹", "av")
    text = text.replace("êœº", "AV")
    text = text.replace("êœ»", "av")
    text = text.replace("êœ¼", "AY")
    text = text.replace("êœ½", "ay")
    text = text.replace("ðŸ™°", "et")
    text = text.replace("ï¬€", "ff")
    text = text.replace("ï¬ƒ", "ffi")
    text = text.replace("ï¬„", "ffl")
    text = text.replace("ï¬", "fi")
    text = text.replace("ï¬‚", "fl")
    text = text.replace("Ç¶", "Hv")
    text = text.replace("Æ•", "hv")
    text = text.replace("â„”", "lb")
    text = text.replace("á»º", "lL")
    text = text.replace("á»»", "ll")
    #text = text.replace("Å’", "OE") # supported in Latin G2
    #text = text.replace("Å“", "oe") # supported in Latin G2
    text = text.replace("êŽ", "OO")
    text = text.replace("ê", "oo")
    text = text.replace("ï¬†", "st")
    text = text.replace("ï¬…", "ft")
    text = text.replace("êœ¨", "TZ")
    text = text.replace("êœ©", "tz")
    text = text.replace("áµ«", "ue")
    text = text.replace("ê­£", "uo")
    text = text.replace("ê ", "VY")
    text = text.replace("ê¡", "vy")

    # map similar characters to one canonical unicode point
    text = text.replace("â‚¬", "â‚ ")
    text = re.sub("[Â·Î‡á›«â€§âˆ™â‹…â‹…â¸±â¸³ãƒ»êž]","Â·",text,flags=re.UNICODE)
    text = text.replace("â€¢", "â—")
    text = text.replace("È˜", "Åž")
    text = text.replace("È™", "ÅŸ")
    text = text.replace("â„«", "Ã…")
    text = text.replace("â€ž", "â€")
    text = text.replace("â€Ÿ", "â€œ")
    text = re.sub("[â€’â€“â€”]","â€•",text,flags=re.UNICODE) # dashes to horizontal bar
    
    text = text.replace("\u00A0", " ") # NBSP to space
    
    # emoji stuff
    text = re.sub("[ðŸ˜Šâ˜º]","ðŸ™‚",text,flags=re.UNICODE) # like slightly smiling face
    text = re.sub("[ðŸ˜ðŸ˜ƒðŸ˜„ðŸ˜†]","ðŸ˜€",text,flags=re.UNICODE) # like grinning face
    text = text.replace("ðŸ˜", "ðŸ˜›") # face with tongue
    text = text.replace("ðŸ¤£", "ðŸ˜‚") # rofl -> face with tears of joy
    text = text.replace("ðŸ¤“", "ðŸ˜Ž") # nerd -> sunglasses
    text = re.sub("[â˜¹ðŸ˜¦]","ðŸ™",text,flags=re.UNICODE) # like slightly frowning face
    text = re.sub("[ðŸ˜­ðŸ˜¥]", "ðŸ˜¢",text,flags=re.UNICODE) # like crying face
    text = re.sub("[ðŸ¤šðŸ‘‹ðŸ–]","âœ‹",text,flags=re.UNICODE) # like raised hand
    text = re.sub("[â™¡â™¥ðŸŽ”ðŸ’“ðŸ’–ðŸ’—ðŸ’˜ðŸ’™ðŸ’šðŸ’›ðŸ’œðŸ’ðŸ’ŸðŸ–¤ðŸ§¡]","â¤",text,flags=re.UNICODE) # like heavy black heart
    text = re.sub("["u"\U0000FE00-\U0000FE0F]","",text,flags=re.UNICODE) # strip variation selectors
    
    return text

enhancementmapping = {
    # map to L1 replacement character, enhancement mode, enhancement data
    # these can be mapped to level 1 characters provided we are using the English language (which we always are right now)
    
    "Â£":[0x23,0,0],
    "â†":[0x5b,0,0],
    "Â½":[0x5c,0,0],
    "â†’":[0x5d,0,0],
    "â†‘":[0x5e,0,0],
    "#":[0x5F,0,0],
    "â€•":[0x60,0,0],
    "Â¼":[0x7b,0,0],
    "â€–":[0x7c,0,0],
    "Â¾":[0x7d,0,0],
    "Ã·":[0x7e,0,0],
    
    # no diacritic - i.e. the Latin G0 character set
    # 0x23 character already present in English NOS
    "Â¤":[0x7f,0x10,0x24],
    "[":[0x28,0x10,0x5b],
    "\\":[0x2f,0x10,0x5c],
    "]":[0x29,0x10,0x5d],
    "^":[0x20,0x10,0x5e], # don't map this to the English â†‘ because of bug in Philips TVs
    "_":[0x20,0x10,0x5f], # don't map this to the English â€• because of bug in Philips TVs
    "`":[0x27,0x10,0x60],
    "{":[0x28,0x10,0x7b],
    "|":[0x20,0x10,0x7c], # don't map this to the English â€– because of bug in Philips TVs
    "}":[0x29,0x10,0x7d],
    "~":[0x7f,0x10,0x7e],

    # grave AEIOUaeiou
    "Ã€":[0x41,0x11,0x41],"Ãˆ":[0x45,0x11,0x45],"ÃŒ":[0x49,0x11,0x49],"Ã’":[0x4F,0x11,0x4F],"Ã™":[0x55,0x11,0x55],
    "Ã ":[0x61,0x11,0x61],"Ã¨":[0x65,0x11,0x65],"Ã¬":[0x69,0x11,0x69],"Ã²":[0x6F,0x11,0x6F],"Ã¹":[0x75,0x11,0x75],

    # acute ACEILNORSUYZacegilnorsuyz
    "Ã":[0x41,0x12,0x41],"Ä†":[0x43,0x12,0x43],"Ã‰":[0x45,0x12,0x45],"Ã":[0x49,0x12,0x49],"Ä¹":[0x4c,0x12,0x4c],"Åƒ":[0x4e,0x12,0x4e],"Ã“":[0x4f,0x12,0x4f],"Å”":[0x52,0x12,0x52],"Åš":[0x53,0x12,0x53],"Ãš":[0x55,0x12,0x55],"Ã":[0x59,0x12,0x59],"Å¹":[0x5a,0x12,0x5a],
    "Ã¡":[0x61,0x12,0x61],"Ä‡":[0x63,0x12,0x63],"Ã©":[0x65,0x12,0x65],"Ã­":[0x69,0x12,0x69],"Äº":[0x6c,0x12,0x6c],"Å„":[0x6e,0x12,0x6e],"Ã³":[0x6f,0x12,0x6f],"Å•":[0x72,0x12,0x72],"Å›":[0x73,0x12,0x73],"Ãº":[0x75,0x12,0x75],"Ã½":[0x79,0x12,0x79],"Åº":[0x7a,0x12,0x7a],

    # circumflex ACEGHIJOSUWYaceghijosuwy
    "Ã‚":[0x41,0x13,0x41],"Äˆ":[0x43,0x13,0x43],"ÃŠ":[0x45,0x13,0x45],"Äœ":[0x47,0x13,0x47],"Ä¤":[0x48,0x13,0x48],"ÃŽ":[0x49,0x13,0x49],"Ä´":[0x4a,0x13,0x4a],"Ã”":[0x4f,0x13,0x4f],"Åœ":[0x53,0x13,0x53],"Ã›":[0x55,0x13,0x55],"Å´":[0x57,0x13,0x57],"Å¶":[0x59,0x13,0x59],
    "Ã¢":[0x61,0x13,0x61],"Ä‰":[0x63,0x13,0x63],"Ãª":[0x65,0x13,0x65],"Ä":[0x67,0x13,0x67],"Ä¥":[0x68,0x13,0x68],"Ã®":[0x69,0x13,0x69],"Äµ":[0x6a,0x13,0x6a],"Ã´":[0x6f,0x13,0x6f],"Å":[0x73,0x13,0x73],"Ã»":[0x75,0x13,0x75],"Åµ":[0x77,0x13,0x77],"Å·":[0x79,0x13,0x79],

    # tilde AINOUainou
    "Ãƒ":[0x41,0x14,0x41],"Ä¨":[0x49,0x14,0x49],"Ã‘":[0x4e,0x14,0x4e],"Ã•":[0x4f,0x14,0x4f],"Å¨":[0x55,0x14,0x55],
    "Ã£":[0x61,0x14,0x61],"Ä©":[0x69,0x14,0x69],"Ã±":[0x6e,0x14,0x6e],"Ãµ":[0x6f,0x14,0x6f],"Å©":[0x75,0x14,0x75],

    # macron AEIOUaeiou
    "Ä€":[0x41,0x15,0x41],"Ä’":[0x45,0x15,0x45],"Äª":[0x49,0x15,0x49],"ÅŒ":[0x4f,0x15,0x4f],"Åª":[0x55,0x15,0x55],
    "Ä":[0x61,0x15,0x61],"Ä“":[0x65,0x15,0x65],"Ä«":[0x69,0x15,0x69],"Å":[0x6f,0x15,0x6f],"Å«":[0x75,0x15,0x75],

    # breve AGUagu
    "Ä‚":[0x41,0x16,0x41],"Äž":[0x47,0x16,0x47],"Å¬":[0x55,0x16,0x55],
    "Äƒ":[0x61,0x16,0x61],"ÄŸ":[0x67,0x16,0x67],"Å­":[0x75,0x16,0x75],

    # dot CEGIZcegz
    "ÄŠ":[0x43,0x17,0x43],"Ä–":[0x45,0x17,0x45],"Ä ":[0x47,0x17,0x47],"Ä°":[0x49,0x17,0x49],"Å»":[0x5a,0x17,0x5a],
    "Ä‹":[0x63,0x17,0x63],"Ä—":[0x65,0x17,0x65],"Ä¡":[0x67,0x17,0x67],"Å¼":[0x7a,0x17,0x7a],

    # diaeresis/umlaut AEIOUYaeiouy
    "Ã„":[0x41,0x18,0x41],"Ã‹":[0x45,0x18,0x45],"Ã":[0x49,0x18,0x49],"Ã–":[0x4f,0x18,0x4f],"Ãœ":[0x55,0x18,0x55],"Å¸":[0x59,0x18,0x59],
    "Ã¤":[0x61,0x18,0x61],"Ã«":[0x65,0x18,0x65],"Ã¯":[0x69,0x18,0x69],"Ã¶":[0x6f,0x18,0x6f],"Ã¼":[0x75,0x18,0x75],"Ã¿":[0x79,0x18,0x79],

    # ring AUau
    "Ã…":[0x41,0x1a,0x41],"Å®":[0x55,0x1a,0x55],
    "Ã¥":[0x61,0x1a,0x61],"Å¯":[0x75,0x1a,0x75],

    # cedilla CGKLNRSTcklnrst
    "Ã‡":[0x43,0x1b,0x43],"Ä¢":[0x47,0x1b,0x47],"Ä¶":[0x4b,0x1b,0x4b],"Ä»":[0x4c,0x1b,0x4c],"Å…":[0x4e,0x1b,0x4e],"Å–":[0x52,0x1b,0x52],"Åž":[0x53,0x1b,0x53],"Èš":[0x54,0x1b,0x54],
    "Ã§":[0x63,0x1b,0x63],"Ä·":[0x6b,0x1b,0x6b],"Ä¼":[0x6c,0x1b,0x6c],"Å†":[0x6e,0x1b,0x6e],"Å—":[0x72,0x1b,0x72],"ÅŸ":[0x73,0x1b,0x73],"È›":[0x74,0x1b,0x74],

    # double acute OUou
    "Å":[0x4f,0x1d,0x4f],"Å°":[0x55,0x1d,0x55],
    "Å‘":[0x6f,0x1d,0x6f],"Å±":[0x75,0x1d,0x75],

    # ogonek AEIUaeiu
    "Ä„":[0x41,0x1e,0x41],"Ä˜":[0x45,0x1e,0x45],"Ä®":[0x49,0x1e,0x49],"Å²":[0x55,0x1e,0x55],
    "Ä…":[0x61,0x1e,0x61],"Ä™":[0x65,0x1e,0x65],"Ä¯":[0x69,0x1e,0x69],"Å³":[0x75,0x1e,0x75],

    # caron/hÃ¡Äek CDELNRSTZcdelnrstz
    "ÄŒ":[0x43,0x1f,0x43],"ÄŽ":[0x44,0x1f,0x44],"Äš":[0x45,0x1f,0x45],"Ä½":[0x4c,0x1f,0x4c],"Å‡":[0x4e,0x1f,0x4e],"Å˜":[0x52,0x1f,0x52],"Å ":[0x53,0x1f,0x53],"Å¤":[0x54,0x1f,0x54],"Å½":[0x5a,0x1f,0x5a],
    "Ä":[0x63,0x1f,0x63],"Ä":[0x64,0x1f,0x64],"Ä›":[0x65,0x1f,0x65],"Ä¾":[0x6c,0x1f,0x6c],"Åˆ":[0x6e,0x1f,0x6e],"Å™":[0x72,0x1f,0x72],"Å¡":[0x73,0x1f,0x73],"Å¥":[0x74,0x1f,0x74],"Å¾":[0x7a,0x1f,0x7a],
    # symbols from the Latin G2 supplementary set
    "Â¡":[0x21,0x0F,0x21],
    "Â¢":[0x63,0x0F,0x22],
    # 0x23 character already present in English NOS
    # 0x24 character already present in English NOS
    "Â¥":[0x59,0x0F,0x25],
    # 0x26 character already present in English NOS
    "Â§":[0x53,0x0F,0x27],
    # 0x28 already mapped from G0 set
    "â€˜":[0x27,0x0F,0x29],
    "â€œ":[0x22,0x0F,0x2a],
    "Â«":[0x3c,0x0F,0x2b],
    # 0x2c character already present in English NOS
    # 0x2d character already present in English NOS
    # 0x2e character already present in English NOS
    "â†“":[0x7f,0x0F,0x2f],
    "Â°":[0x7f,0x0F,0x30],
    "Â±":[0x7f,0x0F,0x31],
    "Â²":[0x7f,0x0F,0x32],
    "Â³":[0x7f,0x0F,0x33],
    "Ã—":[0x7f,0x0F,0x34],
    "Âµ":[0x7f,0x0F,0x35],
    "Â¶":[0x7f,0x0F,0x36],
    "Â·":[0x7f,0x0F,0x37],
    # 0x38 characeter already present in English NOS
    "â€™":[0x27,0x0F,0x39],
    "â€":[0x22,0x0F,0x3a],
    "Â»":[0x3e,0x0F,0x3b],
    # 0x3c character already present in English NOS
    # 0x3d character already present in English NOS
    # 0x3e character already present in English NOS
    "Â¿":[0x3F,0x0F,0x3f],
    # 0x40-0x4f are the diacritic characters
    # 0x50 character already present in English NOS
    "Â¹":[0x7f,0x0F,0x51],
    "Â®":[0x7f,0x0F,0x52],
    "Â©":[0x7f,0x0F,0x53],
    "â„¢":[0x7f,0x0F,0x54],
    "â™ª":[0x7f,0x0F,0x55],
    "â‚ ":[0x45,0x0F,0x56],
    "â€°":[0x7f,0x0F,0x57],
    "âˆ":[0x7f,0x0F,0x58],
    # 0x59-0x5b are reserved
    "â…›":[0x7f,0x0F,0x5c],
    "â…œ":[0x7f,0x0F,0x5d],
    "â…":[0x7f,0x0F,0x5e],
    "â…ž":[0x7f,0x0F,0x5f],
    "Î©":[0x7f,0x0F,0x60],
    "Ã†":[0x7f,0x0F,0x61],
    "Ä":[0x44,0x0F,0x62],
    "Âª":[0x61,0x0F,0x63],
    "Ä¦":[0x48,0x0F,0x64],
    # 0x65 is reserved
    "Ä²":[0x7f,0x0F,0x66],
    "Ä¿":[0x4C,0x0F,0x67],
    "Å":[0x4C,0x0F,0x68],
    "Ã˜":[0x4f,0x0F,0x69],
    "Å’":[0x7f,0x0F,0x6a],
    "Âº":[0x6f,0x0F,0x6b],
    "Ãž":[0x7f,0x0F,0x6c],
    "Å¦":[0x4f,0x0F,0x6d],
    "ÅŠ":[0x7f,0x0F,0x6e],
    "Å‰":[0x6e,0x0F,0x6f],
    "Ä¸":[0x71,0x0F,0x70],
    "Ã¦":[0x7f,0x0F,0x71],
    "Ä‘":[0x64,0x0F,0x72],
    "Ã°":[0x64,0x0F,0x73],
    "Ä§":[0x68,0x0F,0x74],
    "Ä±":[0x69,0x0F,0x75],
    "Ä³":[0x7f,0x0F,0x76],
    "Å€":[0x6C,0x0F,0x77],
    "Å‚":[0x6C,0x0F,0x78],
    "Ã¸":[0x6f,0x0F,0x79],
    "Å“":[0x7f,0x0F,0x7a],
    "ÃŸ":[0x73,0x0F,0x7b],
    "Ã¾":[0x7f,0x0F,0x7c],
    "Å§":[0x4f,0x0F,0x7d],
    "Å‹":[0x7f,0x0F,0x7e],
    
    # G1 mosaics
    "â–Œ":[0x7f,0x01,0x35],
    "â–":[0x7f,0x01,0x6a],
    "â–ˆ":[0x7f,0x01,0x7f],
    
    # G3 smooth mosaics and line drawing set
    "â–’":[0x7f,0x02,0x2f],
    "â—":[0x7f,0x02,0x4D],
    "â¬¤":[0x7f,0x02,0x4E],
    "â—¯":[0x4f,0x02,0x4F],
    
    # emojis from custom gdrcs
    "ðŸ™‚":[0x20,0x0D,0x00], # slightly smiling face
    "ðŸ˜€":[0x20,0x0D,0x01], # grinning face
    "ðŸ˜›":[0x20,0x0D,0x02], # face with tongue
    "ðŸ˜‰":[0x20,0x0D,0x03], # winking face
    "ðŸ˜‚":[0x20,0x0D,0x04], # face with tears of joy
    "ðŸ˜Ž":[0x20,0x0D,0x05], # smiling face with sunglasses
    "ðŸ˜œ":[0x20,0x0D,0x06], # winking face with tongue
    "ðŸ˜®":[0x20,0x0D,0x07], # face with open mouth
    "ðŸ˜µ":[0x20,0x0D,0x08], # dizzy face
    "ðŸ™":[0x20,0x0D,0x09], # slightly frowning face
    "ðŸ˜¢":[0x20,0x0D,0x0A], # crying face
    "ðŸ’¯":[0x20,0x0D,0x0B], # hundred points
    "ðŸ‘":[0x20,0x0D,0x0C], # thumbs up
    "ðŸ‘Ž":[0x20,0x0D,0x0D], # thumbs down
    "ðŸ‘Œ":[0x20,0x0D,0x0E], # OK hand
    "âœ‹":[0x20,0x0D,0x0F], # raised hand
    "â¤":[0x20,0x0D,0x10], # heavy black heart
    "ðŸ’”":[0x20,0x0D,0x11], # broken heart
    
    #todo: more mappings
}

def charenhance(text,offset):
    # replace characters in text string for the level 1 page, and return a list of enhancement triplets
    newtext = ""
    enhancements = []
    for index, char in enumerate(text):
        newchar = enhancementmapping.get(char, [ord(char),0,0])
        if newchar[0] > 127:
            newchar = [0x7F,0,0] # blank unknown unicode characters
        newtext += chr(newchar[0])
        if (newchar[1]):
            enhancements.append([index+offset,newchar[1],newchar[2]])
    return newtext,enhancements
